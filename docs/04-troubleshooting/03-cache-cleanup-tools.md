# 缓存清理工具

本文档介绍博客项目的缓存清理工具的使用方法和最佳实践。

## 清理命令说明

### `pnpm clean` (推荐)

深度清理所有缓存层级，包括：

- Next.js 缓存 (`.next/`)
- 输出目录 (`out/`)
- 依赖缓存 (`node_modules/.cache/`)
- 生成的文件 (`public/search.json`, `app/tag-data.json`)
- 临时文件和构建产物
- Next.js 类型定义文件 (`next-env.d.ts`)

**使用场景：**

- 遇到内容错乱问题时
- 切换分支后需要完全清理
- 依赖更新后需要重新生成所有缓存

### `pnpm clean:safe`

安全清理，只清理必要的缓存：

- Next.js 缓存 (`.next/`)
- 输出目录 (`out/`)
- 生成的文件 (`public/search.json`, `app/tag-data.json`)

**使用场景：**

- 日常开发中的快速清理
- 不想清理依赖缓存时

## 手动清理脚本

也可以直接运行清理脚本：

```bash
# 深度清理
./scripts/clean-cache.sh

# 或者使用bash
bash scripts/clean-cache.sh
```

## 清理后的操作

清理完成后，建议按以下步骤重新构建：

```bash
# 1. 重新安装依赖（如果需要）
pnpm install

# 2. 重新构建项目
pnpm build

# 3. 如果遇到TypeScript错误，运行开发服务器重新生成类型定义
pnpm dev
```

## 注意事项

1. **next-env.d.ts**: 这个文件会被自动删除并重新生成。如果遇到TypeScript错误，请运行 `pnpm dev` 或 `pnpm build` 重新生成。

2. **依赖缓存**: 深度清理会删除 `node_modules/.cache`，这可能会让下次安装依赖稍慢，但能确保干净的构建环境。

3. **构建时间**: 清理后首次构建可能会稍慢，因为需要重新生成所有缓存。

## 故障排除

如果清理后仍然遇到问题：

1. 检查是否有其他进程在使用相关文件
2. 确认所有相关进程已停止
3. 如果是权限问题，使用 `sudo` 运行清理脚本
4. 检查磁盘空间是否充足

## tag-data.json 特殊处理

### 背景

`app/tag-data.json` 是一个自动生成的文件，包含所有博客标签的统计信息。这个文件在不同的构建模式下有不同的处理策略：

### 动态模式 (`pnpm dev`)

在开发模式下：

- 文件会在开发服务器启动时自动生成（空对象）
- 标签数据会在运行时动态加载
- 如果手动删除了此文件，重新启动开发服务器即可重新生成
- 文件内容会根据当前博客内容动态更新

### 静态模式 (`pnpm build`)

在静态构建模式下：

- 文件会在构建过程中自动生成和更新
- 构建脚本会确保这个文件与最新的博客内容保持同步
- 如果博客内容有更新，重新构建会自动更新此文件

### 最佳实践

1. **不要手动编辑** `app/tag-data.json` 文件，它是自动生成的
2. **清理时可以安全删除**，构建过程会重新生成
3. **版本控制中可以忽略**，但为了确保开发环境一致性，建议保留
4. **如果发现标签数据不准确**，运行清理命令后重新构建即可

### 相关文件

- 生成逻辑：`scripts/generate-content.mjs`
- 开发时生成：`scripts/generate-tags-dev.mjs`
- 使用位置：
  - `app/tags/page.tsx` - 标签页面
  - `app/tags/[tag]/page.tsx` - 单个标签页面
  - `layouts/ListLayoutWithTags.tsx` - 标签列表布局
